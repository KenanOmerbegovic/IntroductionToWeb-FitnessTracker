<section id="workout-log">
  <div class="container">
    <div class="workout-log-container">
      <div class="card">
        <h2>Log Your Workout</h2>
        
        <form id="workout-form">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Workout Date *</label>
                <input type="date" class="form-input" id="workout-date" name="workout_date" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Workout Type *</label>
                <select class="form-select" id="workout-type" name="workout_type" required>
                  <option value="">Select workout type...</option>
                  <option value="chest">Chest Day</option>
                  <option value="legs">Leg Day</option>
                  <option value="back">Back Day</option>
                  <option value="shoulders">Shoulders Day</option>
                  <option value="arms">Arms Day</option>
                  <option value="cardio">Cardio</option>
                  <option value="full_body">Full Body</option>
                  <option value="custom">Custom Workout</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Duration (minutes)</label>
            <input type="number" class="form-input" id="duration-minutes" name="duration_minutes" min="1" max="300" placeholder="e.g., 60">
          </div>

          <div class="form-group">
            <label class="form-label">Workout Notes</label>
            <textarea class="form-textarea" id="workout-notes" name="notes" placeholder="How did it feel? Any notes about this workout..." rows="3"></textarea>
          </div>

          <div id="exercise-section">
            <h3>Exercises</h3>
            <div class="exercise-entry mb-3 p-3 border rounded">
              <div class="row">
                <div class="col-md-4">
                  <div class="form-group">
                    <label class="form-label">Exercise *</label>
                    <select class="form-select exercise-name" name="exercises[0][exercise_id]" required>
                      <option value="">Select exercise...</option>
                      <!-- Options will be populated dynamically -->
                    </select>
                  </div>
                </div>
                <div class="col-md-2">
                  <div class="form-group">
                    <label class="form-label">Sets *</label>
                    <input type="number" class="form-input sets" name="exercises[0][sets]" min="1" max="20" value="3" required>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Reps *</label>
                    <input type="number" class="form-input reps" name="exercises[0][reps]" min="1" max="50" value="10" required>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Weight (kg)</label>
                    <input type="number" step="0.5" class="form-input weight" name="exercises[0][weight_kg]" min="0" placeholder="Optional">
                  </div>
                </div>
              </div>
              <div class="mt-2">
                <div class="form-group">
                  <label class="form-label">Notes</label>
                  <input type="text" class="form-input" name="exercises[0][notes]" placeholder="Notes for this exercise">
                </div>
              </div>
              <button type="button" class="btn btn-danger btn-sm remove-exercise mt-2">Remove Exercise</button>
            </div>
          </div>

          <div class="mb-3">
            <button type="button" class="btn btn-success" id="add-exercise">
              <i class="fas fa-plus"></i> Add Another Exercise
            </button>
          </div>
          
          <div class="d-flex justify-content-between mt-4">
            <button type="submit" class="btn btn-primary btn-lg">Save Workout</button>
            <button type="button" class="btn btn-secondary" onclick="window.location.hash='dashboard'">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
let exerciseCounter = 1;

function initWorkoutLog() {

  const user = UserService.getCurrentUser();
  if (!user) {
    window.location.hash = 'login';
    return;
  }
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('workout-date').value = today;
  loadExercises();
  initializeWorkoutForm();
  document.getElementById('add-exercise').addEventListener('click', addExerciseRow);
  document.addEventListener('click', function(e) {
    if (e.target && e.target.classList.contains('remove-exercise')) {
      if (document.querySelectorAll('.exercise-entry').length > 1) {
        e.target.closest('.exercise-entry').remove();
        renumberExerciseFields();
      } else {
        Utils.showToast('You must have at least one exercise', 'warning');
      }
    }
  });
}

function loadExercises() {
  ExerciseService.getAllExercises(function(exercises) {
    const exerciseSelects = document.querySelectorAll('.exercise-name');
    exerciseSelects.forEach(select => {
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      exercises.forEach(exercise => {
        const option = document.createElement('option');
        option.value = exercise.exercise_id;
        option.textContent = exercise.exercise_name + (exercise.muscle_group ? ` (${exercise.muscle_group})` : '');
        select.appendChild(option);
      });
    });
  });
}

function addExerciseRow() {
  const exerciseHtml = `
    <div class="exercise-entry mb-3 p-3 border rounded">
      <div class="row">
        <div class="col-md-4">
          <div class="form-group">
            <label class="form-label">Exercise *</label>
            <select class="form-select exercise-name" name="exercises[${exerciseCounter}][exercise_id]" required>
              <option value="">Select exercise...</option>
            </select>
          </div>
        </div>
        <div class="col-md-2">
          <div class="form-group">
            <label class="form-label">Sets *</label>
            <input type="number" class="form-input sets" name="exercises[${exerciseCounter}][sets]" min="1" max="20" value="3" required>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">Reps *</label>
            <input type="number" class="form-input reps" name="exercises[${exerciseCounter}][reps]" min="1" max="50" value="10" required>
          </div>
        </div>
        <div class="col-md-3">
          <div class="form-group">
            <label class="form-label">Weight (kg)</label>
            <input type="number" step="0.5" class="form-input weight" name="exercises[${exerciseCounter}][weight_kg]" min="0" placeholder="Optional">
          </div>
        </div>
      </div>
      <div class="mt-2">
        <div class="form-group">
          <label class="form-label">Notes</label>
          <input type="text" class="form-input" name="exercises[${exerciseCounter}][notes]" placeholder="Notes for this exercise">
        </div>
      </div>
      <button type="button" class="btn btn-danger btn-sm remove-exercise mt-2">Remove Exercise</button>
    </div>
  `;
  
  document.getElementById('exercise-section').insertAdjacentHTML('beforeend', exerciseHtml);
  
  const newSelect = document.querySelector('.exercise-entry:last-child .exercise-name');
  loadExercisesForSelect(newSelect);
  
  exerciseCounter++;
}

function loadExercisesForSelect(selectElement) {
  ExerciseService.getAllExercises(function(exercises) {
    exercises.forEach(exercise => {
      const option = document.createElement('option');
      option.value = exercise.exercise_id;
      option.textContent = exercise.exercise_name + (exercise.muscle_group ? ` (${exercise.muscle_group})` : '');
      selectElement.appendChild(option);
    });
  });
}

function renumberExerciseFields() {
  const exerciseEntries = document.querySelectorAll('.exercise-entry');
  exerciseEntries.forEach((entry, index) => {
    // Update all input names
    const inputs = entry.querySelectorAll('[name^="exercises["]');
    inputs.forEach(input => {
      const name = input.getAttribute('name');
      const newName = name.replace(/exercises\[\d+\]/, `exercises[${index}]`);
      input.setAttribute('name', newName);
    });
  });
  exerciseCounter = exerciseEntries.length;
}

function initializeWorkoutForm() {
  $('#workout-form').validate({
    rules: {
      workout_date: 'required',
      workout_type: 'required',
      'exercises[0][exercise_id]': 'required',
      'exercises[0][sets]': {
        required: true,
        min: 1,
        max: 20
      },
      'exercises[0][reps]': {
        required: true,
        min: 1,
        max: 50
      }
    },
    messages: {
      workout_date: 'Please select a workout date',
      workout_type: 'Please select a workout type',
      'exercises[0][exercise_id]': 'Please select an exercise',
      'exercises[0][sets]': {
        required: 'Please enter number of sets',
        min: 'Minimum 1 set',
        max: 'Maximum 20 sets'
      },
      'exercises[0][reps]': {
        required: 'Please enter number of reps',
        min: 'Minimum 1 rep',
        max: 'Maximum 50 reps'
      }
    },
    submitHandler: function(form) {
      saveWorkout(form);
    }
  });
}

function saveWorkout(form) {
  const formData = new FormData(form);
  const data = {};
  
  for (let [key, value] of formData.entries()) {
    if (key.startsWith('exercises[')) {
      const match = key.match(/exercises\[(\d+)\]\[(\w+)\]/);
      if (match) {
        const index = parseInt(match[1]);
        const field = match[2];
        
        if (!data.exercises) data.exercises = [];
        if (!data.exercises[index]) data.exercises[index] = {};
        
        // Convert numeric fields
        if (['sets', 'reps', 'weight_kg'].includes(field)) {
          data.exercises[index][field] = value ? parseFloat(value) : null;
        } else if (field === 'exercise_id') {
          data.exercises[index][field] = parseInt(value);
        } else {
          data.exercises[index][field] = value;
        }
      }
    } else if (key === 'duration_minutes' && value) {
      data[key] = parseInt(value);
    } else if (key === 'workout_date' || key === 'workout_type' || key === 'notes') {
      data[key] = value;
    }
  }
  
  // Filter out empty exercises
  if (data.exercises) {
    data.exercises = data.exercises.filter(ex => ex.exercise_id);
  }
  
  // Show loading
  Utils.showLoading();
  
  // Save workout
  WorkoutService.createWorkout(data, function() {
    Utils.hideLoading();
    Utils.showToast('Workout saved successfully!', 'success');
    window.location.hash = 'workout-history';
  }, function(error) {
    Utils.hideLoading();
    Utils.showToast(error.responseJSON?.error || 'Error saving workout', 'error');
  });
}

// Initialize when page loads
initWorkoutLog();
</script>